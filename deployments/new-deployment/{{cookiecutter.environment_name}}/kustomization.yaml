---
# ==============================================================================
# Rossum Agent - {{ cookiecutter.environment_name }} Environment
# ==============================================================================
# Generated for: {{ cookiecutter.deployment_type }} deployment
# Namespace: {{ cookiecutter.namespace }}
# LLM Provider: bedrock
# ==============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

{% if cookiecutter.namespace != "default" -%}
namespace: {{ cookiecutter.namespace }}

{% endif -%}
# Base resources
resources:
{%- if cookiecutter.create_namespace == "yes" %}
  - namespace.yaml
{%- endif %}
  - ../base

# Shared labels
components:
  - ../_shared

# ==============================================================================
# Docker Image Configuration
# ==============================================================================
images:
  - name: app-image
{%- if cookiecutter.docker_registry %}
    newName: {{ cookiecutter.docker_registry }}/{{ cookiecutter.docker_image_name }}
{%- else %}
    newName: {{ cookiecutter.docker_image_name }}
{%- endif %}
    newTag: {{ cookiecutter.docker_image_tag }}

# ==============================================================================
# Application Configuration
# ==============================================================================
configMapGenerator:
  - name: rossum-agent
    behavior: merge
    literals:
{%- if cookiecutter.deployment_type == "aws-eks" %}
      - REGION_NAME={{ cookiecutter.aws_region }}
      - AWS_REGION={{ cookiecutter.aws_region }}
{%- else %}
      - REGION_NAME={{ cookiecutter.environment_name }}
      - AWS_REGION={{ cookiecutter.environment_name }}
{%- endif %}
      - LLM_MODEL_ID={{ cookiecutter.llm_model_id }}
      - BASE_URL={{ cookiecutter.base_url }}

# ==============================================================================
# Secrets Configuration
# ==============================================================================
{%- if cookiecutter.use_secrets_manager == "no" %}
secretGenerator:
  - name: rossum-agent
    literals:
      # AWS Bedrock uses IAM credentials - no API key needed
      - PLACEHOLDER=bedrock-uses-iam
{%- endif %}

# ==============================================================================
# Patches and Customizations
# ==============================================================================
patches:
{%- if cookiecutter.deployment_type == "local" %}
  # Remove ExternalSecret for local development
  - patch: |-
      $patch: delete
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: rossum-agent

  # Remove AWS IAM role annotation
  - patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: rossum-agent
        annotations:
          eks.amazonaws.com/role-arn: null
{% endif -%}

{%- if cookiecutter.use_ingress == "no" %}
  # Remove Ingress - use port-forward instead
  - patch: |-
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: rossum-agent
{% endif -%}

{%- if cookiecutter.deployment_type == "aws-eks" and cookiecutter.aws_account_id %}
  # Configure AWS IAM role for service account
  - patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: rossum-agent
        annotations:
          eks.amazonaws.com/role-arn: arn:aws:iam::{{ cookiecutter.aws_account_id }}:role/app-{{ cookiecutter.cluster_name }}-{{ cookiecutter.namespace }}-rossum-agent
{% endif -%}

{%- if cookiecutter.use_ingress == "yes" %}
  # Configure Ingress hostname
  - patch: |-
      - op: replace
        path: /spec/rules/0/host
        value: {{ cookiecutter.ingress_host }}
{%- if cookiecutter.ingress_tls == "yes" %}
      - op: replace
        path: /spec/tls/0/hosts/0
        value: {{ cookiecutter.ingress_host }}
      - op: replace
        path: /spec/tls/0/secretName
        value: rossum-agent-tls
{%- endif %}
    target:
      kind: Ingress
      name: rossum-agent
{% endif -%}

  # Resource limits
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: {{ cookiecutter.replicas }}
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "{{ cookiecutter.cpu_request }}"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "{{ cookiecutter.memory_request }}"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "{{ cookiecutter.cpu_limit }}"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "{{ cookiecutter.memory_limit }}"
    target:
      kind: Deployment
      name: rossum-agent
