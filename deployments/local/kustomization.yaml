---
# ==============================================================================
# Rossum Agent - Local Deployment Configuration (NON-WORKING EXAMPLE)
# ==============================================================================
# ⚠️ WARNING: This configuration is kept as a reference example ONLY.
#
# Local Kubernetes deployment is overly complex when connecting to AWS Bedrock.
# For local development, use Docker Compose instead - see README.md
#
# Why not use this?
#   - Requires manual AWS credential management via `aws sts assume-role`
#   - Credentials expire after a few hours
#   - Complex debugging when things fail
#   - Docker Compose is much simpler (just mount ~/.aws directory)
#
# If you really want to try this (not recommended):
#   1. Get AWS credentials: aws sts assume-role --role-arn ... --role-session-name local-dev
#   2. Update secretGenerator below with AccessKeyId, SecretAccessKey, SessionToken
#   3. Build image: docker build -t rossum-agent:local .
#   4. Load to cluster (if using kind): kind load docker-image rossum-agent:local
#   5. Deploy: kubectl apply -k deployments/local
#   6. Access: kubectl port-forward service/rossum-agent 8501:8501
# ==============================================================================

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Base resources
resources:
  - ../base

# Shared labels
components:
  - ../_shared

# ==============================================================================
# Docker Image Configuration
# ==============================================================================
images:
  - name: app-image
    newName: rossum-agent
    newTag: local

# ==============================================================================
# Application Configuration
# ==============================================================================
configMapGenerator:
  - name: rossum-agent
    behavior: merge
    literals:
      # Local region settings
      - REGION_NAME=local
      - AWS_REGION=eu-central-1

      # LLM Model Configuration (Bedrock only)
      - LLM_MODEL_ID=bedrock/eu.anthropic.claude-sonnet-4-5-20250929-v1:0

      # Application URL
      - BASE_URL=http://localhost:8501

# ==============================================================================
# Secrets Configuration
# ==============================================================================
# AWS Bedrock with assumed role credentials from dev-eu environment
# Note: Rossum API credentials are configured in the app UI, not here.
# ==============================================================================
# To get credentials, run:
#   aws sts assume-role \
#     --role-arn arn:aws:iam::494114742120:role/app-dev-eu-tools-rossum-agent \
#     --role-session-name local-dev
# Then paste the credentials below.
# ==============================================================================
secretGenerator:
  - name: rossum-agent
    literals:
      # Replace with credentials from assume-role output:
      - AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY_ID_HERE
      - AWS_SECRET_ACCESS_KEY=YOUR_SECRET_ACCESS_KEY_HERE
      - AWS_SESSION_TOKEN=YOUR_SESSION_TOKEN_HERE

# ==============================================================================
# Resource Optimization for Local Development
# ==============================================================================
# These patches customize the deployment for local environments:
#   - Remove AWS-specific resources (IAM roles, ExternalSecrets, Ingress)
#   - Reduce CPU/memory requirements for local development
# ==============================================================================
patches:
  # Remove ExternalSecret (not needed for local - we use secretGenerator)
  - patch: |-
      $patch: delete
      apiVersion: external-secrets.io/v1
      kind: ExternalSecret
      metadata:
        name: rossum-agent

  # Remove AWS IAM role from ServiceAccount
  - patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: rossum-agent
        annotations:
          eks.amazonaws.com/role-arn: null

  # Remove Ingress (use port-forward instead)
  - patch: |-
      $patch: delete
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: rossum-agent

  # Reduce resource requirements for local development
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "0.25"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "1"
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "2Gi"
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: "Always"
    target:
      kind: Deployment
      name: rossum-agent
